import React, { useState, useEffect } from 'react';
import { Package, DollarSign, LayoutDashboard, Plus, Grid, List, ArrowLeft, AlertTriangle, TrendingUp, Archive } from 'lucide-react';

const InventoryApp = () => {
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [viewMode, setViewMode] = useState('grid');
  const [showProductModal, setShowProductModal] = useState(false);
  const [showSaleModal, setShowSaleModal] = useState(false);
  const [showDetailsModal, setShowDetailsModal] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [products, setProducts] = useState([]);
  const [sales, setSales] = useState([]);

  // Load data from storage on mount
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      // NOTE: Assuming 'window.storage.get' returns an object with a 'value' property as per original code
      const productsResult = await window.storage.get('products');
      const salesResult = await window.storage.get('sales');
      
      if (productsResult && productsResult.value) {
        setProducts(JSON.parse(productsResult.value));
      }
      if (salesResult && salesResult.value) {
        setSales(JSON.parse(salesResult.value));
      }
    } catch (error) {
      console.log('No existing data found, starting fresh');
    }
  };

  const saveProducts = async (newProducts) => {
    setProducts(newProducts);
    try {
      await window.storage.set('products', JSON.stringify(newProducts));
    } catch (error) {
      console.error('Error saving products:', error);
    }
  };

  const saveSales = async (newSales) => {
    setSales(newSales);
    try {
      await window.storage.set('sales', JSON.stringify(newSales));
    } catch (error) {
      console.error('Error saving sales:', error);
    }
  };

  const addProduct = (productData) => {
    const newProduct = {
      id: Date.now().toString(),
      ...productData,
      createdAt: new Date().toISOString()
    };
    saveProducts([...products, newProduct]);
    setShowProductModal(false);
  };

  const addSale = (saleData, productId = null) => {
    const newSale = {
      id: Date.now().toString(),
      ...saleData,
      productId: productId || saleData.productId,
      saleDate: saleData.saleDate || new Date().toISOString().split('T')[0],
      createdAt: new Date().toISOString()
    };
    
    // Update inventory
    const updatedProducts = products.map(p => {
      if (p.id === newSale.productId) {
        const stockKey = `${newSale.size}-${newSale.color}`;
        return {
          ...p,
          stock: {
            ...p.stock,
            [stockKey]: Math.max(0, (p.stock[stockKey] || 0) - 1)
          }
        };
      }
      return p;
    });
    
    saveProducts(updatedProducts);
    saveSales([...sales, newSale]);
    setShowSaleModal(false);
  };

  const returnSale = (saleId) => {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;

    // Restore inventory
    const updatedProducts = products.map(p => {
      if (p.id === sale.productId) {
        const stockKey = `${sale.size}-${sale.color}`;
        return {
          ...p,
          stock: {
            ...p.stock,
            [stockKey]: (p.stock[stockKey] || 0) + 1
          }
        };
      }
      return p;
    });

    saveProducts(updatedProducts);
    saveSales(sales.filter(s => s.id !== saleId));
  };

  const calculateDashboardMetrics = () => {
    const today = new Date().toISOString().split('T')[0];
    const thisWeekStart = new Date();
    thisWeekStart.setDate(thisWeekStart.getDate() - 7);
    const thisMonthStart = new Date();
    thisMonthStart.setDate(1);

    const todaySales = sales.filter(s => s.saleDate === today);
    const weekSales = sales.filter(s => new Date(s.saleDate) >= thisWeekStart);
    const monthSales = sales.filter(s => new Date(s.saleDate) >= thisMonthStart);

    const revenueToday = todaySales.reduce((sum, s) => sum + parseFloat(s.salePrice || 0), 0);
    const revenueWeek = weekSales.reduce((sum, s) => sum + parseFloat(s.salePrice || 0), 0);
    const revenueMonth = monthSales.reduce((sum, s) => sum + parseFloat(s.salePrice || 0), 0);

    // Low stock warnings
    const criticalStock = [];
    const potentialLowStock = [];
    const zeroStock = [];

    products.forEach(product => {
      Object.entries(product.stock || {}).forEach(([variant, quantity]) => {
        const [size, color] = variant.split('-');
        const item = { product: product.name, size, color, quantity };
        
        if (quantity === 0) {
          zeroStock.push(item);
        } else if (quantity <= 2) {
          criticalStock.push(item);
        } else if (quantity <= 5) {
          potentialLowStock.push(item);
        }
      });
    });

    // Calculate inventory value
    const wholesaleValue = products.reduce((sum, p) => {
      const totalStock = Object.values(p.stock || {}).reduce((s, q) => s + q, 0);
      return sum + (totalStock * parseFloat(p.wholesalePrice || 0));
    }, 0);

    const retailValue = products.reduce((sum, p) => {
      const totalStock = Object.values(p.stock || {}).reduce((s, q) => s + q, 0);
      return sum + (totalStock * parseFloat(p.price || 0));
    }, 0);

    // Best selling product
    const productSales = {};
    sales.forEach(s => {
      productSales[s.productId] = (productSales[s.productId] || 0) + 1;
    });
    const bestSellingId = Object.keys(productSales).reduce((a, b) => 
      productSales[a] > productSales[b] ? a : b, null);
    const bestSelling = products.find(p => p.id === bestSellingId);

    // Slow movers
    const sixtyDaysAgo = new Date();
    sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
    const recentSaleProductIds = new Set(
      sales.filter(s => new Date(s.saleDate) >= sixtyDaysAgo).map(s => s.productId)
    );
    const slowMovers = products.filter(p => !recentSaleProductIds.has(p.id));

    return {
      revenueToday,
      revenueWeek,
      revenueMonth,
      salesToday: todaySales.length,
      criticalStock,
      potentialLowStock,
      zeroStock,
      wholesaleValue,
      retailValue,
      bestSelling,
      slowMovers
    };
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Navigation */}
      <nav className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex space-x-8">
              <button
                onClick={() => setCurrentPage('dashboard')}
                className={`inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium ${
                  currentPage === 'dashboard'
                    ? 'border-blue-500 text-gray-900'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <LayoutDashboard className="w-5 h-5 mr-2" />
                Dashboard
              </button>
              <button
                onClick={() => setCurrentPage('products')}
                className={`inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium ${
                  currentPage === 'products'
                    ? 'border-blue-500 text-gray-900'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <Package className="w-5 h-5 mr-2" />
                Products
              </button>
              <button
                onClick={() => setCurrentPage('sales')}
                className={`inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium ${
                  currentPage === 'sales'
                    ? 'border-blue-500 text-gray-900'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <DollarSign className="w-5 h-5 mr-2" />
                Sales
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {currentPage === 'dashboard' && <DashboardPage metrics={calculateDashboardMetrics()} />}
        {currentPage === 'products' && (
          <ProductsPage
            products={products}
            viewMode={viewMode}
            setViewMode={setViewMode}
            setShowProductModal={setShowProductModal}
            setShowSaleModal={setShowSaleModal}
            setShowDetailsModal={setShowDetailsModal}
            setSelectedProduct={setSelectedProduct}
          />
        )}
        {currentPage === 'sales' && (
          <SalesPage
            sales={sales}
            products={products}
            setShowSaleModal={setShowSaleModal}
            returnSale={returnSale}
          />
        )}
      </main>

      {/* Modals */}
      {showProductModal && (
        <ProductModal
          onClose={() => setShowProductModal(false)}
          onSave={addProduct}
        />
      )}
      {showSaleModal && (
        <SaleModal
          products={products}
          selectedProduct={selectedProduct}
          onClose={() => {
            setShowSaleModal(false);
            setSelectedProduct(null);
          }}
          onSave={addSale}
        />
      )}
      {showDetailsModal && selectedProduct && (
        <ProductDetailsModal
          product={selectedProduct}
          onClose={() => {
            setShowDetailsModal(false);
            setSelectedProduct(null);
          }}
        />
      )}
    </div>
  );
};

const DashboardPage = ({ metrics }) => {
  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold text-gray-900">Dashboard</h1>

      {/* Warning Section */}
      {(metrics.criticalStock.length > 0 || metrics.zeroStock.length > 0) && (
        <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
          <div className="flex items-center mb-3">
            <AlertTriangle className="w-5 h-5 text-red-600 mr-2" />
            <h2 className="text-lg font-semibold text-red-900">Critical Inventory Alerts</h2>
          </div>
          
          {metrics.zeroStock.length > 0 && (
            <div className="mb-4">
              <h3 className="font-medium text-red-800 mb-2">⚫ Out of Stock ({metrics.zeroStock.length} items)</h3>
              <div className="space-y-1">
                {metrics.zeroStock.slice(0, 5).map((item, i) => (
                  <div key={i} className="text-sm text-red-700">
                    {item.product} - {item.color} - Size {item.size}
                  </div>
                ))}
                {metrics.zeroStock.length > 5 && (
                  <div className="text-sm text-red-600 font-medium">
                    +{metrics.zeroStock.length - 5} more items
                  </div>
                )}
              </div>
            </div>
          )}

          {metrics.criticalStock.length > 0 && (
            <div>
              <h3 className="font-medium text-red-800 mb-2">🚨 Critical Low Stock ≤ 2 units ({metrics.criticalStock.length} items)</h3>
              <div className="space-y-1">
                {metrics.criticalStock.slice(0, 5).map((item, i) => (
                  <div key={i} className="text-sm text-red-700">
                    {item.product} - {item.color} - Size {item.size}: {item.quantity} left
                  </div>
                ))}
                {metrics.criticalStock.length > 5 && (
                  <div className="text-sm text-red-600 font-medium">
                    +{metrics.criticalStock.length - 5} more items
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      )}

      {metrics.potentialLowStock.length > 0 && (
        <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
          <div className="flex items-center">
            <AlertTriangle className="w-5 h-5 text-yellow-600 mr-2" />
            <h3 className="font-medium text-yellow-900">
              🟡 Potential Low Stock: {metrics.potentialLowStock.length} items with ≤ 5 units
            </h3>
          </div>
        </div>
      )}

      {/* Sales Snapshot */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="text-sm font-medium text-gray-500">Revenue Today</div>
          <div className="text-2xl font-bold text-gray-900 mt-2">${metrics.revenueToday.toFixed(2)}</div>
          <div className="text-sm text-gray-600 mt-1">{metrics.salesToday} sales</div>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="text-sm font-medium text-gray-500">This Week</div>
          <div className="text-2xl font-bold text-gray-900 mt-2">${metrics.revenueWeek.toFixed(2)}</div>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="text-sm font-medium text-gray-500">This Month</div>
          <div className="text-2xl font-bold text-gray-900 mt-2">${metrics.revenueMonth.toFixed(2)}</div>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="text-sm font-medium text-gray-500">Best Seller</div>
          <div className="text-lg font-bold text-gray-900 mt-2">
            {metrics.bestSelling?.name || 'N/A'}
          </div>
        </div>
      </div>

      {/* Inventory Value */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-sm font-medium text-gray-500">Total Inventory (Wholesale)</div>
              <div className="text-2xl font-bold text-gray-900 mt-2">${metrics.wholesaleValue.toFixed(2)}</div>
            </div>
            <Archive className="w-10 h-10 text-blue-500" />
          </div>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-sm font-medium text-gray-500">Potential Revenue (Retail)</div>
              <div className="text-2xl font-bold text-gray-900 mt-2">${metrics.retailValue.toFixed(2)}</div>
            </div>
            <TrendingUp className="w-10 h-10 text-green-500" />
          </div>
        </div>
      </div>

      {/* Slow Movers */}
      {metrics.slowMovers.length > 0 && (
        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="font-semibold text-gray-900 mb-3">📊 Slow Movers (No sales in 60 days)</h3>
          <div className="space-y-2">
            {metrics.slowMovers.slice(0, 5).map((product, i) => (
              <div key={i} className="text-sm text-gray-700 border-b pb-2">
                {product.name} - ${product.price}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

const ProductsPage = ({ products, viewMode, setViewMode, setShowProductModal, setShowSaleModal, setShowDetailsModal, setSelectedProduct }) => {
  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-gray-900">Products</h1>
        <div className="flex space-x-2">
          <button
            onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}
            className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center"
          >
            {viewMode === 'grid' ? <List className="w-5 h-5 mr-2" /> : <Grid className="w-5 h-5 mr-2" />}
            {viewMode === 'grid' ? 'List View' : 'Grid View'}
          </button>
          <button
            onClick={() => setShowProductModal(true)}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center"
          >
            <Plus className="w-5 h-5 mr-2" />
            New Product
          </button>
        </div>
      </div>

      {products.length === 0 ? (
        <div className="text-center py-12 bg-white rounded-lg shadow">
          <Package className="w-16 h-16 mx-auto text-gray-400 mb-4" />
          <p className="text-gray-500">No products yet. Add your first product to get started.</p>
        </div>
      ) : viewMode === 'grid' ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {products.map(product => (
            <ProductCard
              key={product.id}
              product={product}
              onSell={() => {
                setSelectedProduct(product);
                setShowSaleModal(true);
              }}
              onDetails={() => {
                setSelectedProduct(product);
                setShowDetailsModal(true);
              }}
            />
          ))}
        </div>
      ) : (
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wholesale</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {products.map(product => (
                <tr key={product.id}>
                  <td className="px-6 py-4">
                    <div className="flex items-center">
                      {product.imageUrl && (
                        <img src={product.imageUrl} alt={product.name} className="w-12 h-12 rounded object-cover mr-3" />
                      )}
                      <div className="font-medium text-gray-900">{product.name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 text-gray-900">${product.price}</td>
                  <td className="px-6 py-4 text-gray-900">${product.wholesalePrice}</td>
                  <td className="px-6 py-4">
                    <div className="text-sm">
                      {Object.entries(product.stock || {}).map(([variant, qty]) => (
                        <div key={variant} className={qty <= 2 ? 'text-red-600 font-medium' : 'text-gray-600'}>
                          {variant}: {qty}
                        </div>
                      ))}
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <div className="flex space-x-2">
                      <button
                        onClick={() => {
                          setSelectedProduct(product);
                          setShowSaleModal(true);
                        }}
                        className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                      >
                        Sell
                      </button>
                      <button
                        onClick={() => {
                          setSelectedProduct(product);
                          setShowDetailsModal(true);
                        }}
                        className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                      >
                        Details
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};

const ProductCard = ({ product, onSell, onDetails }) => {
  const totalStock = Object.values(product.stock || {}).reduce((sum, qty) => sum + qty, 0);
  const hasLowStock = Object.values(product.stock || {}).some(qty => qty <= 2);

  return (
    <div className="bg-white rounded-lg shadow overflow-hidden hover:shadow-lg transition-shadow">
      {product.imageUrl && (
        <img src={product.imageUrl} alt={product.name} className="w-full h-48 object-cover" />
      )}
      <div className="p-4">
        <h3 className="font-semibold text-lg text-gray-900 mb-2">{product.name}</h3>
        <div className="space-y-1 mb-4">
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">Price:</span>
            <span className="font-medium text-gray-900">${product.price}</span>
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">Wholesale:</span>
            <span className="font-medium text-gray-900">${product.wholesalePrice}</span>
          </div>
          <div className="mt-2 pt-2 border-t">
            <div className="text-sm font-medium text-gray-700 mb-1">Stock Availability:</div>
            <div className="space-y-1">
              {Object.entries(product.stock || {}).map(([variant, qty]) => (
                <div key={variant} className="flex justify-between text-sm">
                  <span className="text-gray-600">{variant}:</span>
                  <span className={`font-medium ${qty <= 2 ? 'text-red-600' : qty <= 5 ? 'text-yellow-600' : 'text-green-600'}`}>
                    {qty} units
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>
        {hasLowStock && (
          <div className="mb-3 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
            ⚠️ Low stock alert
          </div>
        )}
        <div className="flex space-x-2">
          <button
            onClick={onSell}
            className="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium"
          >
            Sell
          </button>
          <button
            onClick={onDetails}
            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
          >
            Details
          </button>
        </div>
      </div>
    </div>
  );
};

const SalesPage = ({ sales, products, setShowSaleModal, returnSale }) => {
  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-gray-900">Sales</h1>
        <button
          onClick={() => setShowSaleModal(true)}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center"
        >
          <Plus className="w-5 h-5 mr-2" />
          New Sale
        </button>
      </div>

      {sales.length === 0 ? (
        <div className="text-center py-12 bg-white rounded-lg shadow">
          <DollarSign className="w-16 h-16 mx-auto text-gray-400 mb-4" />
          <p className="text-gray-500">No sales recorded yet.</p>
        </div>
      ) : (
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Color</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Platform</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {[...sales].reverse().map(sale => {
                const product = products.find(p => p.id === sale.productId);
                return (
                  <tr key={sale.id}>
                    <td className="px-6 py-4 text-sm text-gray-900">{sale.saleDate}</td>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">
                      {product?.name || sale.productName || 'Unknown'}
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-900">{sale.size}</td>
                    <td className="px-6 py-4 text-sm text-gray-900">{sale.color}</td>
                    <td className="px-6 py-4 text-sm text-gray-900">{sale.platform}</td>
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">${sale.salePrice}</td>
                    <td className="px-6 py-4">
                      <button
                        onClick={() => returnSale(sale.id)}
                        className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm flex items-center"
                      >
                        <ArrowLeft className="w-4 h-4 mr-1" />
                        Return
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};

const ProductModal = ({ onClose, onSave }) => {
  const [formData, setFormData] = useState({
    name: '',
    color: '',
    sizes: '',
    sizeChart: '',
    fabric: '',
    washingInstructions: '',
    description: '',
    imageUrl: '',
    price: '',
    wholesalePrice: '',
    stock: {}
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    
    // Parse sizes and create stock object
    const sizesArray = formData.sizes.split(',').map(s => s.trim()).filter(s => s); // Added filter(s => s) to remove empty strings
    const colorsArray = formData.color.split(',').map(c => c.trim()).filter(c => c); // Added filter(c => c) to remove empty strings
    const stock = {};
    
    // If no sizes/colors are specified, use defaults to prevent errors
    const effectiveSizes = sizesArray.length > 0 ? sizesArray : ['One Size'];
    const effectiveColors = colorsArray.length > 0 ? colorsArray : ['Default Color'];

    effectiveSizes.forEach(size => {
      effectiveColors.forEach(color => {
        const key = `${size}-${color}`;
        stock[key] = 0;
      });
    });

    onSave({
      ...formData,
      stock
    });
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      {/* FIXED: Added max-h-[90vh] and overflow-y-auto to the inner div */}
      <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="p-6">
          <h2 className="text-2xl font-bold text-gray-900 mb-4">New Product</h2>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
              <input
                type="text"
                required
                value={formData.name}
                onChange={(e) => setFormData({...formData, name: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Color(s) (comma-separated)</label>
              <input
                type="text"
                required
                placeholder="Black, White, Blue"
                value={formData.color}
                onChange={(e) => setFormData({...formData, color: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Size Variations (comma-separated)</label>
              <input
                type="text"
                required
                placeholder="S, M, L, XL"
                value={formData.sizes}
                onChange={(e) => setFormData({...formData, sizes: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Size Chart</label>
              <textarea
                value={formData.sizeChart}
                onChange={(e) => setFormData({...formData, sizeChart: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows="3"
                placeholder="S: Chest 36-38, M: Chest 39-41..."
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Fabric Composition</label>
              <input
                type="text"
                value={formData.fabric}
                onChange={(e) => setFormData({...formData, fabric: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="100% Cotton"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Washing Instructions</label>
              <textarea
                value={formData.washingInstructions}
                onChange={(e) => setFormData({...formData, washingInstructions: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows="2"
                placeholder="Machine wash cold, tumble dry low"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Product Description</label>
              <textarea
                value={formData.description}
                onChange={(e) => setFormData({...formData, description: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows="3"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
              <input
                type="url"
                value={formData.imageUrl}
                onChange={(e) => setFormData({...formData, imageUrl: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="https://example.com/image.jpg"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Price</label>
                <input
                  type="number"
                  step="0.01"
                  required
                  value={formData.price}
                  onChange={(e) => setFormData({...formData, price: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Wholesale Price</label>
                <input
                  type="number"
                  step="0.01"
                  required
                  value={formData.wholesalePrice}
                  onChange={(e) => setFormData({...formData, wholesalePrice: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            <div className="bg-blue-50 p-4 rounded-lg">
              <p className="text-sm text-blue-800">
                Stock will be initialized to 0 for all size/color combinations. You can update stock quantities after creating the product.
              </p>
            </div>

            <div className="flex space-x-3 pt-4">
              <button
                type="submit"
                className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
              >
                Create Product
              </button>
              <button
                type="button"
                onClick={onClose}
                className="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

const SaleModal = ({ products, selectedProduct, onClose, onSave }) => {
  const [formData, setFormData] = useState({
    productId: selectedProduct?.id || '',
    size: '',
    color: '',
    salePrice: selectedProduct?.price || '',
    platform: '',
    saleDate: new Date().toISOString().split('T')[0]
  });

  const currentProduct = products.find(p => p.id === formData.productId) || selectedProduct;
  const availableVariants = currentProduct ? Object.keys(currentProduct.stock || {}) : [];

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      {/* FIXED: Added max-h-[90vh] and overflow-y-auto to the inner div */}
      <div className="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div className="p-6">
          <h2 className="text-2xl font-bold text-gray-900 mb-4">New Sale</h2>
          <form onSubmit={handleSubmit} className="space-y-4">
            {!selectedProduct && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Product</label>
                <select
                  required
                  value={formData.productId}
                  onChange={(e) => {
                    const product = products.find(p => p.id === e.target.value);
                    setFormData({
                      ...formData,
                      productId: e.target.value,
                      salePrice: product?.price || '',
                      size: '',
                      color: ''
                    });
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">Select a product</option>
                  {products.map(p => (
                    <option key={p.id} value={p.id}>{p.name}</option>
                  ))}
                </select>
              </div>
            )}

            {currentProduct && (
              <>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Size & Color</label>
                  <select
                    required
                    value={`${formData.size}-${formData.color}`}
                    onChange={(e) => {
                      const [size, color] = e.target.value.split('-');
                      setFormData({...formData, size, color});
                    }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value="">Select size and color</option>
                    {availableVariants.map(variant => {
                      const stock = currentProduct.stock[variant];
                      return (
                        <option key={variant} value={variant} disabled={stock === 0}>
                          {variant} ({stock} available)
                        </option>
                      );
                    })}
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sale Price</label>
                  <input
                    type="number"
                    step="0.01"
                    required
                    value={formData.salePrice}
                    onChange={(e) => setFormData({...formData, salePrice: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sale Platform</label>
                  <input
                    type="text"
                    required
                    value={formData.platform}
                    onChange={(e) => setFormData({...formData, platform: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Website, Instagram, Etsy..."
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Sale Date</label>
                  <input
                    type="date"
                    required
                    value={formData.saleDate}
                    onChange={(e) => setFormData({...formData, saleDate: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </>
            )}

            <div className="flex space-x-3 pt-4">
              <button
                type="submit"
                className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium"
              >
                Record Sale
              </button>
              <button
                type="button"
                onClick={onClose}
                className="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

const ProductDetailsModal = ({ product, onClose }) => {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      {/* FIXED: Added max-h-[90vh] and overflow-y-auto to the inner div */}
      <div className="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div className="p-6">
          <div className="flex justify-between items-start mb-6">
            <h2 className="text-2xl font-bold text-gray-900">{product.name}</h2>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          {product.imageUrl && (
            <img
              src={product.imageUrl}
              alt={product.name}
              className="w-full h-64 object-cover rounded-lg mb-6"
            />
          )}

          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-gray-50 p-4 rounded-lg">
                <div className="text-sm text-gray-600 mb-1">Retail Price</div>
                <div className="text-2xl font-bold text-gray-900">${product.price}</div>
              </div>
              <div className="bg-gray-50 p-4 rounded-lg">
                <div className="text-sm text-gray-600 mb-1">Wholesale Price</div>
                <div className="text-2xl font-bold text-gray-900">${product.wholesalePrice}</div>
              </div>
            </div>

            {product.description && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-2">Description</h3>
                <p className="text-gray-700">{product.description}</p>
              </div>
            )}

            <div>
              <h3 className="font-semibold text-gray-900 mb-2">Stock Availability</h3>
              <div className="bg-gray-50 p-4 rounded-lg">
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                  {Object.entries(product.stock || {}).map(([variant, qty]) => (
                    <div key={variant} className="flex justify-between items-center">
                      <span className="text-sm text-gray-700">{variant}:</span>
                      <span className={`font-medium ${qty <= 2 ? 'text-red-600' : qty <= 5 ? 'text-yellow-600' : 'text-green-600'}`}>
                        {qty} units
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {product.fabric && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-2">Fabric Composition</h3>
                <p className="text-gray-700">{product.fabric}</p>
              </div>
            )}

            {product.sizeChart && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-2">Size Chart</h3>
                <p className="text-gray-700 whitespace-pre-line">{product.sizeChart}</p>
              </div>
            )}

            {product.washingInstructions && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-2">Care Instructions</h3>
                <p className="text-gray-700">{product.washingInstructions}</p>
              </div>
            )}
          </div>

          <div className="mt-6">
            <button
              onClick={onClose}
              className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default InventoryApp
